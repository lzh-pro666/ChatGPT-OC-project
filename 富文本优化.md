好的 👍，我把前面两次的分析整理成一个**技术总结**，方便你整体把握：

---

## iOS AI 聊天 App 流式回复的技术总结

### 1. 两种渲染方式

* **逐 token 追加**

  * 每收到一个 token 就更新 UI。
  * 缺点：频繁触发富文本排版，CPU 占用高，容易掉帧。
  * 优点：实现简单，实时感强。

* **逐行追加（推荐）**

  * SSE 收到内容后，先在后台做 **完整富文本排版**，缓存每行的 range。
  * 前台只在「整行准备好」时更新一次 UI，并配合遮罩做 reveal 动画。
  * 优点：

    * UI 更新频率低，性能好。
    * 遮罩动画更自然。
    * 不会出现逐 token 抖动、重排。

---

### 2. 行级缓存与分行实现

* 不能简单依赖 **插入特殊符号** 来分行，因为：

  * 容易破坏 `NSAttributedString` 的属性（粗体、链接、代码块）。
  * 字体排版差异可能导致后台和前台断行不一致。
* 正确做法：

  * 用 CoreText (`CTFramesetter` + `CTLineGetStringRange`) 或 TextKit 直接计算每行 range。
  * 缓存成 `NSArray<NSRange>`，对应每一行文本。
  * 前台显示时，只要依次取 substring → 拼接 → 渐显。

---

### 3. 动画效果（模拟 ChatGPT / 豆包的丝滑流式感）

* 使用 **遮罩 (mask layer)** 做从左到右 reveal，而不是逐字修改透明度。
* Reveal 时机：

  1. SSE 收到第一行 → 隐藏「思考中」视图。
  2. 每行准备好 → 使用 mask 动画显示。
  3. 一行完成后 → 继续下一行。

---

### 4. 性能优化点

* **后台排版**：富文本拼接、断行计算在子线程完成。
* **前台只负责动画**：显示时只是从缓存拿 substring，不再计算排版。
* **一致性保证**：气泡宽度在后台计算和前台显示保持一致，否则会错行。
* **部分行渲染**：SSE 还没结束时，可以先显示已完整的行，半行 token 暂存。

---

✅ **结论**

* 行级流式渲染 + 遮罩 reveal 是比逐 token 渲染更高效、更丝滑的方案。
* 关键在于：**后台用 CoreText/TextKit 切行 → 前台按行播放 → 遮罩动画 reveal**。
* 这种实现方式能兼顾性能、流畅度、富文本一致性，接近 ChatGPT / 豆包 / DeepSeek 的交互体验。

---

# 逐行富文本渲染（按气泡宽度换行 + 遮盖）落地方案

本方案将 SSE 流式结果交给富文本渲染，在“气泡有效宽度”下做行级断行缓存，只在“整行就绪”时推进 UI，并用遮罩（mask）做逐行显露。该方案可避免逐 token 重排引起的抖动，保证丝滑与一致性。

## 目标
- 整体流式：后端持续产出文本 → 前台按行推进显示。
- 一致断行：严格使用“聊天气泡有效宽度”做断行，保证后台/前台一致。
- 无中间空白：仅当首行富文本准备好后才隐藏思考视图。
- 行级显露：每次只显露一行（遮罩 reveal），显露完成再推进下一行。
- 智能滚动：仅当“AI 气泡底部贴近 table 底部”或“几何接近底部”时自动粘底；用户上滑时不打扰。

## 核心流程
1) SSE 收到 partial → 进入富文本节点（RichMessageCellNode）
2) 生成 attributedString（保留 Markdown 样式）
3) 用 TextKit/CTFramesetter 按“气泡宽度”计算行范围（NSArray<NSRange>）
4) 找到“整行就绪”的上界（通常为 totalLines - 1，最后一行视为半行）
5) 只推进“新就绪的整行”：
   - 将该行文本追加到 finalText（已完成内容）
   - 当前行用 reveal 节奏做 mask 显露（300ms，行间 80ms 梯度）
6) 首行显露完成 → 通知 VC 隐藏“思考视图”（一次性回调）
7) 流结束 → 最后一行也推进 + 完成态（移除 mask，确保完全可见）

## 富文本节点改造
### 新增状态
- 行缓存：`NSArray<NSValue *> *lineRects` 或 `NSArray<NSRange> *lineRanges`
- 计数器：`NSInteger revealedLineCount`（已推进到 final 的整行数）
- 两层文本：
  - `finalTextNode`：承载已完成的行（不可再变）
  - `revealTextNode`：承载“当前要显露的那一行”，配合 `CAShapeLayer *mask`
- 回调：`firstLineDidDisplay`（首行显露完成后调用一次）

### 关键 API（Node）
- `- (void)pushStreamingText:(NSString *)text bubbleWidth:(CGFloat)width;`
  - 输入当前 full 文本（SSE 聚合）与“气泡有效宽度”
  - 内部：解析 Markdown → 生成 attributed → TextKit 行测量
  - 只推进“新就绪的整行”（reveal 一行，完成后 flush 到 final）
- `- (void)completeStreamingUpdate;`
  - 流结束时推进最后一行 → 关闭动画 → 清理 mask
- `@property (nonatomic, copy) void (^firstLineDidDisplay)(void);`
  - 首行显露完成后触发，供 VC 隐藏思考视图

### 行测量（TextKit）
- 使用 `NSTextStorage/NSLayoutManager/NSTextContainer`：
  - `NSTextContainer.size = { bubbleWidth, CGFLOAT_MAX }`
  - `lineFragmentUsedRectForGlyphAtIndex:effectiveRange:` 迭代所有行 → 产出每行 `NSRange`
- 注意：当宽度变化时需重新计算行缓存（旋转/尺寸变更）

### 显露节奏（逐行）
- revealTextNode.layer.mask = CAShapeLayer
- 单行显露：从 0 → 该行宽度，300ms，EaseOut；行间延迟 80ms
- 显露完成：将该行 flush 到 finalTextNode，revealTextNode 清空
- 首行完成时触发 firstLineDidDisplay 回调（仅一次）

## 控制器对接
### 思考视图隐藏时机
- 现有做法：收到首个 partial 就隐藏 → 可能出现空白气泡
- 改造后：
  - 首个 partial 到达时仅创建富文本节点，不隐藏思考视图
  - 给 node 赋值 `firstLineDidDisplay = ^{ 删除思考行 + 插入AI气泡行 + 粘底 }`
  - 确保 UI 上“思考”到“首行文本”的无缝切换

### 智能滚动
- 每次 flush 一行后由 VC 调用一次 `performSmartStickIfNeeded`（50ms 节流）：
  - 条件：用户未拖动 && （AI 气泡底部贴近 table 底部 || 几何接近底部 120pt）
  - 动作：`anchorStickToBottomPreservingOffset` 无动画粘底，避免抖动

## 误差与兼容
- 仅推进整行：`newFullyLines = totalLines - 1`，最后一行作为半行暂不显示
- 旋转/宽度变化：行缓存失效 → 重测量 → 从 `revealedLineCount` 继续推进
- 代码块：代码块也按行测量并逐行推进（不破坏语法高亮）

## 性能
- 后台：解析与断行计算（QOS：USER_INITIATED）
- 主线程：只做行显露（mask + 轻微淡入）与 final 文本拼接
- 显示节奏：结合现有 `kStreamRenderInterval`，每 tick 最多推进 1 行（可调）

## 最小改动清单
1. RichMessageCellNode：
   - 添加 `finalTextNode/revealTextNode/mask/revealedLineCount/firstLineDidDisplay`
   - 实现 `pushStreamingText:bubbleWidth:`、`completeStreamingUpdate`
   - TextKit 行测量工具函数（按气泡宽度）
2. ChatDetailViewControllerV2：
   - 首个 partial 到达只“创建 Node 不隐藏思考”
   - 绑定 `firstLineDidDisplay`：隐藏思考 + 插入AI行 + 智能粘底
   - 每次行 flush 后触发一次 `performSmartStickIfNeeded`

---

以上为完全可行且高性能的落地路径。若你确认，我将：
- 按上述 API 在 `RichMessageCellNode` 中补齐行级推进实现
- 调整 `simulateAIResponse` 的隐藏思考视图时机
- 将推进频率改为“每 tick 最多 1 行”，并与遮罩动画时间（300ms）协调，获得更顺滑的观感

