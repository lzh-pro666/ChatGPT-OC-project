# 自动滚动功能说明

## 功能概述

自动滚动功能确保在聊天过程中，当用户处于底部时，新消息会自动滚动到可见区域，提供流畅的聊天体验。

## 触发时机

### 1. 用户发送消息后
- **触发点**：`sendButtonTapped` 方法
- **行为**：立即滚动到底部
- **代码**：
```objective-c
- (void)sendButtonTapped {
    // ... 其他代码 ...
    
    // 发送消息后立即滚动到底部
    [self scrollToBottomAnimated:YES];
    
    // ... 其他代码 ...
}
```

### 2. 新消息添加后
- **触发点**：`addMessageWithText:isFromUser:completion:` 方法
- **行为**：在插入动画完成后滚动到底部
- **代码**：
```objective-c
[self.tableNode performBatchUpdates:^{
    [self.tableNode insertRowsAtIndexPaths:@[newIndexPath] withRowAnimation:UITableViewRowAnimationFade];
} completion:^(BOOL finished) {
    // 在动画完成后滚动到底部
    [self scrollToBottomAnimated:YES];
    if (completion) {
        completion();
    }
}];
```

### 3. AI开始响应时
- **触发点**：`startTypingTimer` 方法
- **行为**：启动打字机效果前滚动到底部
- **代码**：
```objective-c
- (void)startTypingTimer {
    // ... 其他代码 ...
    
    // 启动定时器前自动滚动到底部
    [self scrollToBottomAnimated:YES];
    
    // ... 其他代码 ...
}
```

### 4. 打字机效果更新时
- **触发点**：`performMessageUpdate:` 方法
- **行为**：仅在用户处于底部时自动滚动
- **代码**：
```objective-c
if (shouldStickToBottom) {
    // 用户在底部 - 自动滚动到最新消息
    [self scrollToBottomAnimated:YES];
} else {
    // 用户已向上滚动 - 不改变滚动位置
}
```

## 智能滚动策略

### 1. 底部检测
```objective-c
- (BOOL)isScrolledToBottom {
    if (!self.tableNode.view) return NO;
    
    CGFloat contentHeight = self.tableNode.view.contentSize.height;
    CGFloat viewHeight = self.tableNode.view.bounds.size.height;
    
    // 如果内容还没填满一屏，也算是在底部
    if (contentHeight < viewHeight) {
        return YES;
    }
    
    CGFloat offsetY = self.tableNode.view.contentOffset.y;
    CGFloat tolerance = 20.0; // 容差
    
    return offsetY + viewHeight >= contentHeight - tolerance;
}
```

### 2. 条件滚动
- **用户在底部**：新消息时自动滚动
- **用户已向上滚动**：保持当前滚动位置，不强制滚动

## 滚动方法

### 1. 基础滚动
```objective-c
- (void)scrollToBottom {
    [self scrollToBottomAnimated:YES];
}
```

### 2. 可控制动画的滚动
```objective-c
- (void)scrollToBottomAnimated:(BOOL)animated {
    if (self.messages.count > 0) {
        dispatch_async(dispatch_get_main_queue(), ^{
            NSIndexPath *lastIndexPath = [NSIndexPath indexPathForRow:self.messages.count - 1 inSection:0];
            [self.tableNode scrollToRowAtIndexPath:lastIndexPath 
                                  atScrollPosition:UITableViewScrollPositionBottom 
                                          animated:animated];
        });
    }
}
```

## 用户体验

### 1. 流畅性
- 使用动画滚动，提供视觉反馈
- 在适当的时机触发，避免突兀的跳跃

### 2. 智能性
- 只在用户处于底部时自动滚动
- 尊重用户的滚动意图

### 3. 一致性
- 所有新消息都遵循相同的滚动规则
- 保持聊天界面的连贯性

## 技术实现

### 1. 异步执行
```objective-c
dispatch_async(dispatch_get_main_queue(), ^{
    // 滚动操作
});
```

### 2. 动画控制
```objective-c
[UIView animateWithDuration:0.1 delay:0 options:UIViewAnimationOptionCurveEaseOut animations:^{
    // 布局更新和滚动
} completion:nil];
```

### 3. 状态检测
```objective-c
BOOL shouldStickToBottom = [self isScrolledToBottom];
```

## 注意事项

1. **性能考虑**：避免在滚动过程中进行复杂的布局计算
2. **用户体验**：不要强制滚动，尊重用户的浏览意图
3. **动画协调**：确保滚动动画与消息插入动画协调一致
4. **边界情况**：处理空消息列表和异常情况

## 测试要点

1. **基本功能**：发送消息后是否正确滚动
2. **AI响应**：打字机效果时是否正确滚动
3. **用户意图**：向上滚动后是否保持位置
4. **性能表现**：大量消息时的滚动性能
5. **边界情况**：空聊天、单条消息等特殊情况
