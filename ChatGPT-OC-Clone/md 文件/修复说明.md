# 闪退问题修复说明

## 问题分析

应用出现闪退，错误信息：
```
*** Assertion failure in -[ASDisplayNode calculateLayoutLayoutSpec:], ASDisplayNode+LayoutSpec.mm:74
*** Terminating app due to uncaught exception 'NSInternalInconsistencyException', reason: 'Node <ASDisplayNode: 0x107834000> returned layout spec <ASStackLayoutSpec: 0x10b805150; vertical; children = [ <ASTextNode: 0x10704a600> ]> that has already been used. Layout specs should always be regenerated.'
```

## 问题原因

1. **布局规范重复使用**：在 `RichMessageCellNode` 中，我们创建了一个 `ASStackLayoutSpec` 对象，然后在 `layoutSpecBlock` 中返回了同一个对象
2. **违反 ASDK 规则**：ASDK 要求布局规范对象不能被重复使用，每次调用时都应该创建新的对象

## 修复方案

### 1. 修复布局规范重复使用问题

**修改前**：
```objective-c
- (void)updateContentNode {
    // 创建布局规范
    ASStackLayoutSpec *verticalStack = [ASStackLayoutSpec stackLayoutSpecWithDirection:...];
    
    // 在 block 中返回同一个对象（错误）
    self.contentNode.layoutSpecBlock = ^ASLayoutSpec * _Nonnull(__kindof ASDisplayNode * _Nonnull node, ASSizeRange constrainedSize) {
        return verticalStack;  // ❌ 重复使用同一个对象
    };
}
```

**修改后**：
```objective-c
- (void)updateContentNode {
    // 在 block 中每次都创建新的布局规范
    self.contentNode.layoutSpecBlock = ^ASLayoutSpec * _Nonnull(__kindof ASDisplayNode * _Nonnull node, ASSizeRange constrainedSize) {
        // 创建子节点
        NSMutableArray<ASDisplayNode *> *childNodes = [NSMutableArray array];
        // ... 创建子节点逻辑
        
        // 每次都创建新的布局规范
        return [ASStackLayoutSpec stackLayoutSpecWithDirection:...];  // ✅ 每次都创建新对象
    };
}
```

### 2. 简化代码块处理

暂时移除复杂的代码块视图，先确保基本功能正常：
- 所有内容都使用 `ASTextNode` 显示
- 避免使用 `ASDisplayNode initWithViewBlock:`
- 减少布局复杂性

### 3. 简化欢迎消息

使用更简单的 Markdown 格式进行测试：
```objective-c
NSString *welcomeMessage = @"您好！我是ChatGPT，一个AI助手。我可以帮助您解答问题，请问有什么我可以帮您的吗？\n\n我可以支持**粗体文本**和*斜体文本*格式。";
```

## 修复后的代码结构

1. **RichMessageCellNode**：
   - 修复了布局规范重复使用问题
   - 简化了内容显示逻辑
   - 确保每次调用都创建新的布局规范

2. **ChatDetailViewController**：
   - 简化了欢迎消息
   - 使用 `RichMessageCellNode` 替代 `MessageCellNode`

## 测试步骤

1. **编译测试**：确保没有编译错误
2. **运行测试**：启动应用，检查是否还会闪退
3. **功能测试**：验证富文本显示是否正常
4. **逐步恢复**：在基本功能正常后，逐步添加代码块功能

## 下一步计划

1. **基本功能稳定后**，重新添加代码块视图
2. **优化性能**，减少不必要的布局计算
3. **添加更多 Markdown 支持**，如链接、图片等

## 注意事项

- ASDK 的布局规范对象不能被重复使用
- 每次调用 `layoutSpecBlock` 时都应该创建新的布局规范
- 避免在布局规范中保存状态或引用
