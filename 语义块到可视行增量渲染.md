### 语义块 → 可视行 的增量渲染（RichMessageCellNode + AICodeBlockNode）

本文聚焦在 `RichMessageCellNode` 内部从“语义块（Semantic Blocks）”到“可视行（Visual Lines）”的增量渲染全过程，包含富文本化处理、代码高亮、文本行与代码行的渲染路径，以及所用到的 Texture 技术要点。

---

## 总体流程
1) 控制器把“语义块”增量喂给当前 AI 节点：`appendSemanticBlocks:isFinal:`。
2) Cell 将语义块切分为“行任务”（文本行、代码行），并按节奏逐行渲染；首行追加前发通知以便控制器移除“思考行”并粘底。
3) 文本行以 `ASTextNode` 呈现、代码行进入 `AICodeBlockNode`；过程中尽量在后台处理富文本/高亮，主线程只做轻量 UI 更新。

---

## 入口与调度（RichMessageCellNode）
- 入口方法：`appendSemanticBlocks:isFinal:`
  - 累入 `pendingSemanticBlockQueue`
  - 同步累积 `currentMessage`（避免外部与内部状态不一致）
  - 若空闲则 `processNextSemanticBlockIfIdle`
- 生成“行任务”：`buildLineTasksForBlockText:completion:`（后台）
  - 使用 `AIMarkdownParser` 把语义块切分为 Markdown 结构（段落、标题、围栏代码等）
  - 对“文本块”按固定可视宽度切分成若干行（`lineFragmentsForAttributedString:width:`）
  - 对“代码块”逐行拆分，并计算每行像素宽度，供 `AICodeBlockNode` 设定固定内容宽度
- 逐行推进：`scheduleNextLineTask` → `performNextLineTask`
  - 统一节奏：`lineRenderInterval` 与 `codeLineRenderInterval`（默认同值 0.41675s）
  - 首行前：发送 `RichMessageCellNodeWillAppendFirstLine`、显示气泡并请求布局
  - 文本行：即时创建 `ASTextNode` 并追加
  - 代码行：创建或复用 `AICodeBlockNode`，调用 `updateCodeText:` 追加内容
  - 每行结束：节流布局、合并逐行通知（`RichMessageCellNodeDidAppendLine`），控制器据此执行粘底

代码参考：
```1127:1154:ChatGPT-OC-Clone/View/RichMessageCellNode.m
- (void)appendSemanticBlocks:(NSArray<NSString *> *)blocks isFinal:(BOOL)isFinal { ... }
```
```1356:1471:ChatGPT-OC-Clone/View/RichMessageCellNode.m
- (void)performNextLineTask { ... }
```

---

## 富文本化（文本行）
- 基础样式：`attributedStringForText:` 赋予段落样式（行间距、换行规则）与前景色/字体（区分用户/AI）。
- Markdown 增强：`applyMarkdownStyles:` 应用粗体、斜体、行内代码、URL/Email 样式（基于正则；可点击链接取决于外部 delegate）。
- 在“逐行模式”中，文本行通常已在后台被切分成 `NSAttributedString`，主线程仅创建 `ASTextNode` 并设置属性，减少主线程压力。

相关代码：
```582:708:ChatGPT-OC-Clone/View/RichMessageCellNode.m
- (NSAttributedString *)attributedStringForText:(NSString *)text { ... }
- (void)applyMarkdownStyles:(NSMutableAttributedString *)attributedString { ... }
```

渲染要点：
- `ASTextNode` 设置 `maximumNumberOfLines = 0`，`flexGrow/flexShrink = 1`，提升自适应能力。
- 行级追加时做相邻去重检查，避免重复渲染同一文本。
- 通过“节流布局”降低 layout 频率（`performDelayedLayoutUpdate`）。

---

## 代码高亮与代码行渲染（AICodeBlockNode）
- 封装节点：`AICodeBlockNode`，内部包含：
  - 头部：语言标签（`ASTextNode`）+ 复制按钮（`ASButtonNode`）
  - 代码：`ASTextNode` 包裹在 `ASScrollNode`（横向滚动容器）中，允许超宽代码横向滑动
- 语法高亮：`AISyntaxHighlighter` 根据语言规则生成 `NSAttributedString`；
  - 流中采用“增量高亮”（仅处理追加的后缀）减少消耗；
  - 在流式结束时可调用 `finalizeHighlighting` 做一次全量高亮与最终布局，确保一致性。
- 内容宽度：
  - 依据“最长行像素宽度”动态设置 `codeNode` 宽度（或使用 `setFixedContentWidth:`）
  - `ASScrollNode` 提供横向滚动，`directionalLockEnabled` 降低与纵向手势的冲突
- 文本追加：
  - `updateCodeText:` 在后台高亮追加部分，主线程合并到 `appliedAttr` 并刷新 `codeNode`
  - 更新后异步刷新内容宽度，避免主线程阻塞

代码参考：
```12:29:ChatGPT-OC-Clone/View/AICodeBlockNode.h
@interface AICodeBlockNode : ASDisplayNode ...
```
```135:213:ChatGPT-OC-Clone/View/AICodeBlockNode.m
- (void)updateCodeText:(NSString *)code { ... }
```
```271:320:ChatGPT-OC-Clone/View/AICodeBlockNode.m
- (void)updateCodeContentWidthAsync { ... }
```

---

## Texture 技术要点
- `ASCellNode`/`ASDisplayNode` 自动管理子节点（`automaticallyManagesSubnodes = YES`）降低样板代码。
- `ASLayoutSpec`：
  - `ASStackLayoutSpec` 纵向堆叠文本与附件、代码头与代码容器。
  - `ASInsetLayoutSpec` 控制内外边距。
  - `ASBackgroundLayoutSpec` 复用气泡背景（`bubbleNode`）。
- `ASTextNode`：
  - `layerBacked = YES` 减少 UIView 生成与层级开销（尤其逐行追加场景）。
- 异步与节流：
  - 后台解析/高亮（GCD）+ 主线程轻量更新。
  - 帧级合并通知（`CADisplayLink`）与延迟布局，降低刷新频率。
- 横向滚动：
  - `ASScrollNode` 作为代码容器，手势配置倾向横向，并广播开始/结束交互到控制器暂停/恢复自动粘底。

---

## 首行与粘底配合
- 首行追加前：
  - 发送 `RichMessageCellNodeWillAppendFirstLine` → 控制器移除思考行并锚定底部
  - 若启用了 `startHiddenUntilFirstLine`，此时显示气泡与内容并请求一次布局
- 每行完成：
  - 合并逐行通知 `RichMessageCellNodeDidAppendLine` → 控制器执行“事件驱动 + 防抖”的粘底

代码参考：
```1362:1370:ChatGPT-OC-Clone/View/RichMessageCellNode.m
// 首行即将加入，显示气泡与内容，并发送 WillAppendFirstLine
```
```1488:1495:ChatGPT-OC-Clone/View/RichMessageCellNode.m
// 帧级合并通知 DidAppendLine
```

---

## 渲染稳定性与性能
- 相邻重复行/重复块去重，避免 UI 抖动。
- 文本与代码均采用“只增不减”的尺寸策略（高度单调递增），减少果冻回弹。
- 逐行节奏统一（文本/代码同频），避免速度切换带来的突兀感。
- 控制器侧在用户拖动/代码横滚时暂停 UI 更新，保证交互优先级。

---

## 快速索引（方法/类）
- 入口：`appendSemanticBlocks:isFinal:`、`processNextSemanticBlockIfIdle`、`buildLineTasksForBlockText:completion:`、`performNextLineTask`
- 富文本：`attributedStringForText:`、`applyMarkdownStyles:`
- 代码块：`AICodeBlockNode`（`updateCodeText:`、`setFixedContentWidth:`、`updateCodeContentWidthAsync`、`layout`）
- 通知：`RichMessageCellNodeWillAppendFirstLine`、`RichMessageCellNodeDidAppendLine`
- Texture：`ASTextNode`、`ASScrollNode`、`ASStackLayoutSpec`、`ASInsetLayoutSpec`、`ASBackgroundLayoutSpec`
