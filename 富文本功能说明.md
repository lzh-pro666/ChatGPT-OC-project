# 富文本聊天功能说明

## 功能特性

### 1. Markdown 支持
- **粗体文本**: 使用 `**文本**` 格式
- **斜体文本**: 使用 `*文本*` 格式  
- **行内代码**: 使用 `` `代码` `` 格式
- **代码块**: 使用 ``` 包围的代码块，支持语言标识

### 2. 代码高亮
- 代码块自动识别语言类型
- 支持复制代码功能
- 代码块有独立的背景色和圆角设计

### 3. 防抖动机制
- 打字机效果更新时减少文字抖动
- 使用防抖动算法优化UI更新频率
- 平滑的滚动动画

## 技术实现

### 核心组件

1. **RichMessageCellNode**: 富文本消息节点
   - 支持 Markdown 解析
   - 自动布局和高度计算
   - 防抖动更新机制

2. **CodeBlockView**: 代码块视图
   - 代码高亮显示
   - 一键复制功能
   - 语言标识显示

3. **ParserResult**: 解析结果模型
   - 存储解析后的富文本内容
   - 区分普通文本和代码块

### Markdown 解析

支持以下 Markdown 语法：
- `**粗体**` → 粗体文本
- `*斜体*` → 斜体文本
- `` `代码` `` → 行内代码
- ```swift\n代码\n``` → 代码块

### 性能优化

1. **防抖动更新**: 减少不必要的UI更新
2. **异步布局**: 使用 ASDK 的异步布局机制
3. **内存管理**: 合理管理富文本对象生命周期

## 使用示例

### 发送包含 Markdown 的消息

```objective-c
NSString *message = @"这是一个**粗体**文本，包含*斜体*和`行内代码`。\n\n```swift\nlet greeting = \"Hello, World!\"\nprint(greeting)\n```";

[[CoreDataManager sharedManager] addMessageToChat:chat 
                                          content:message 
                                       isFromUser:NO];
```

### 自定义代码块样式

可以在 `CodeBlockView.m` 中修改代码块的样式：

```objective-c
// 修改背景色
self.backgroundColor = [UIColor colorWithRed:0.95 green:0.95 blue:0.95 alpha:1.0];

// 修改字体
self.codeTextView.font = [UIFont monospacedSystemFontOfSize:14 weight:UIFontWeightRegular];
```

## 注意事项

1. **性能考虑**: 复杂的 Markdown 内容可能影响解析性能
2. **内存使用**: 大量富文本内容会增加内存占用
3. **兼容性**: 确保在低版本 iOS 设备上正常工作

## 扩展功能

可以进一步扩展支持：
- 图片显示
- 链接点击
- 表格渲染
- 数学公式
- 更多代码语言高亮
