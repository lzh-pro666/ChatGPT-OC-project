# 属性重复声明修复说明

## 问题描述
编译时出现错误：
```
/Users/mac-lzh/Desktop/uitest/chatgpttest2/ChatGPT-OC-Clone/Controller/ChatDetailViewControllerV2.m:64:1 Property has a previous declaration
```

## 问题原因
`lastDisplayedSubstring` 属性被重复声明了两次：

### 第一次声明（第54行）
```objc
// MARK: - 流式更新相关属性
@property (nonatomic, copy) NSString *lastDisplayedSubstring; // 上次显示的文本内容，用于按行更新检测
```

### 第二次声明（第64行）
```objc
// MARK: - 布局优化属性
@property (nonatomic, copy) NSString *lastDisplayedSubstring; // 缓存上次显示的字符串，避免重复布局
```

## 修复方案
删除重复的属性声明，保留第一个声明，并更新注释以反映其双重用途。

### 修复前
```objc
// MARK: - 流式更新相关属性
@property (nonatomic, copy) NSString *lastDisplayedSubstring; // 上次显示的文本内容，用于按行更新检测

// MARK: - 布局优化属性
@property (nonatomic, copy) NSString *lastDisplayedSubstring; // 缓存上次显示的字符串，避免重复布局
```

### 修复后
```objc
// MARK: - 流式更新相关属性
@property (nonatomic, copy) NSString *lastDisplayedSubstring; // 上次显示的文本内容，用于按行更新检测和避免重复布局

// MARK: - 布局优化属性
// lastDisplayedSubstring 属性已移至流式更新相关属性部分
```

## 修复步骤

### 1. 删除重复的属性声明
- 移除"布局优化属性"部分的 `lastDisplayedSubstring` 声明
- 保留"流式更新相关属性"部分的声明

### 2. 更新注释
- 将第一个声明的注释更新为：`// 上次显示的文本内容，用于按行更新检测和避免重复布局`
- 这样既说明了按行更新的用途，也说明了避免重复布局的用途

### 3. 验证修复
- 确保只有一个 `lastDisplayedSubstring` 属性声明
- 确保所有对该属性的引用都指向同一个声明

## 修复后的代码结构

```objc
// MARK: - 流式更新相关属性
@property (nonatomic, strong) NSMutableString *fullResponseBuffer; // 流式响应的完整文本缓冲区
@property (nonatomic, weak) id currentUpdatingAINode; // 兼容普通与富文本节点
@property (nonatomic, strong) NSMutableDictionary<NSString *, NSValue *> *nodeSizeCache; // 节点尺寸缓存
@property (nonatomic, copy) NSString *lastDisplayedSubstring; // 上次显示的文本内容，用于按行更新检测和避免重复布局
@property (nonatomic, assign) BOOL streamBusy; // 防重复/忙碌标记

// MARK: - 网络请求相关属性
@property (nonatomic, strong) NSURLSessionDataTask *currentStreamingTask;
@property (nonatomic, weak) NSManagedObject *currentUpdatingAIMessage; // 正在更新的AI消息对象

// MARK: - 布局优化属性
@property (nonatomic, assign) NSInteger layoutUpdateCounter;
@property (nonatomic, strong) NSMutableDictionary<NSString *, NSValue *> *heightCache; // 高度缓存：key为内容hash，value为CGSize
@property (nonatomic, assign) NSTimeInterval lastLayoutUpdateTime; // 上次布局更新的时间戳，用于防抖控制
```

## 注意事项
1. 确保所有对 `lastDisplayedSubstring` 的引用都正确
2. 该属性现在承担两个职责：
   - 按行更新检测：避免相同内容的重复更新
   - 布局优化：避免重复布局
3. 在初始化时记得设置初始值：`self.lastDisplayedSubstring = @"";`

## 验证方法
1. 检查编译是否通过
2. 确认按行更新功能正常工作
3. 确认布局优化功能正常工作
4. 检查控制台日志是否显示正确的按行更新信息
