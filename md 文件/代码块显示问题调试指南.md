# 代码块显示问题调试指南

## 问题描述

代码块在富文本消息中显示为空白占位，而不是预期的代码内容。

## 可能的原因

1. **解析问题**：`ResponseParsingTask` 没有正确识别代码块
2. **节点创建问题**：代码块节点创建失败或配置错误
3. **布局问题**：代码块节点的尺寸计算或布局约束问题
4. **渲染问题**：节点没有正确添加到渲染树中

## 调试步骤

### 1. 启用调试日志

确保在 `RichMessageCellNode.m` 中启用了详细的调试日志：

```objc
// 在 updateContentNode 方法中
NSLog(@"RichMessageCellNode: updateContentNode 开始，parsedResults count: %lu", (unsigned long)self.parsedResults.count);

// 在处理每个解析结果时
NSLog(@"RichMessageCellNode: 处理第 %ld 个结果，isCodeBlock: %@, content: %@", 
      (long)i, result.isCodeBlock ? @"YES" : @"NO", 
      [result.attributedString.string substringToIndex:MIN(50, result.attributedString.string.length)]);
```

### 2. 测试代码块解析

使用测试方法验证解析逻辑：

```objc
// 在 ChatDetailViewControllerV2 中调用
RichMessageCellNode *testNode = [[RichMessageCellNode alloc] initWithMessage:@"测试" isFromUser:NO];
[testNode testCodeBlockDisplay];
```

### 3. 手动设置测试数据

绕过解析器，直接设置测试数据：

```objc
[testNode setTestParsedResults];
```

### 4. 检查控制台输出

运行应用并查看控制台输出，寻找以下关键信息：

- 解析结果数量
- 每个结果的 `isCodeBlock` 状态
- 代码块语言信息
- 节点创建和添加的日志

## 预期输出

### 正常情况下的日志

```
RichMessageCellNode: updateContentNode 开始，parsedResults count: 3
RichMessageCellNode: 处理第 0 个结果，isCodeBlock: NO, content: 这是普通文本
RichMessageCellNode: 处理第 1 个结果，isCodeBlock: YES, content: func hello() { print("Hello, World!") }
RichMessageCellNode: 处理第 2 个结果，isCodeBlock: NO, content: 这是代码块后的文本
RichMessageCellNode: 创建代码块节点
RichMessageCellNode: 代码块节点已添加到 childNodes，当前数量: 2
RichMessageCellNode: 最终 childNodes 数量: 3, renderNodes 数量: 0
RichMessageCellNode: 更新渲染节点
RichMessageCellNode: updateContentNode 完成
```

### 问题情况下的日志

如果代码块仍然不显示，检查是否有以下问题：

1. **解析结果为空**：`parsedResults count: 0`
2. **代码块识别失败**：`isCodeBlock: NO`
3. **节点创建失败**：没有 "创建代码块节点" 的日志
4. **节点添加失败**：`childNodes` 数量不正确

## 常见问题及解决方案

### 问题1：解析结果为空

**原因**：`ResponseParsingTask` 没有正确解析文本
**解决**：检查 `parseText` 方法的实现，确保代码块正则表达式正确

### 问题2：代码块识别失败

**原因**：`isCodeBlock` 属性设置错误
**解决**：检查 `ParserResult` 的初始化，确保 `isCodeBlock` 正确设置

### 问题3：节点创建失败

**原因**：代码块节点创建过程中出错
**解决**：检查 `createCodeBlockNode` 方法，确保所有必要的属性都正确设置

### 问题4：布局问题

**原因**：代码块节点的尺寸计算错误
**解决**：检查 `layoutSpecBlock` 的实现，确保约束正确

## 测试用例

### 基本代码块测试

```markdown
这是一个测试消息

```swift
func hello() {
    print("Hello, World!")
}
```

这是代码块后的文本
```

### 多语言代码块测试

```markdown
Python 代码：

```python
def hello():
    print("Hello, Python!")
```

JavaScript 代码：

```javascript
function hello() {
    console.log("Hello, JavaScript!");
}
```
```

### 未闭合代码块测试

```markdown
这是一个未闭合的代码块：

```swift
func hello() {
    print("Hello!")
// 注意：这里没有闭合标记
```

## 下一步调试

如果以上步骤仍然无法解决问题，请：

1. 检查 `ParserResult` 类的实现
2. 验证 `ResponseParsingTask` 的代码块检测逻辑
3. 确认 `RichMessageCellNode` 的布局系统配置
4. 使用 Instruments 或 Xcode 调试器进行深入分析

## 联系支持

如果问题仍然存在，请提供：

1. 完整的控制台日志输出
2. 测试用例的实际运行结果
3. 相关的代码片段
4. 设备/模拟器信息

