æˆ‘çœ‹äº†ä¸€ä¸‹ä½ è¿™ä»½ `AttachmentScrollNode.m`ï¼Œå¯¼è‡´ **å›¾ç‰‡æ˜¾ç¤ºåŒºåŸŸè¿‡å°** çš„åŸå› ä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªé—®é¢˜ç‚¹ï¼š

---

### 1. ä½ æŠŠ `ASImageNode/ASNetworkImageNode` æ›¿æ¢æˆäº† `ASButtonNode`

* `ASButtonNode` çš„ `imageNode` é»˜è®¤ **å†…å®¹æ¨¡å¼æ˜¯ `scaleAspectFit`**ï¼Œå³ä¾¿ä½ è®¾ç½®äº† `buttonNode.contentMode = UIViewContentModeScaleAspectFill;`ï¼Œå¯¹å†…éƒ¨çš„ `imageNode` ä¸èµ·ä½œç”¨ã€‚
* æ‰€ä»¥å›¾ç‰‡å®é™…æ˜¾ç¤ºä¼šè¢«ç¼©å°ï¼Œè€Œä¸æ˜¯å¡«æ»¡ `imageSize`ã€‚

ğŸ‘‰ ä¿®å¤æ–¹å¼ï¼š
åœ¨åˆ›å»ºæŒ‰é’®æ—¶è¦æ˜ç¡®è®¾ç½® **å†…éƒ¨çš„ `imageNode` çš„ contentMode**ï¼š

```objc
buttonNode.imageNode.contentMode = UIViewContentModeScaleAspectFill;
buttonNode.imageNode.clipsToBounds = YES;
```

è€Œä¸æ˜¯åªå¯¹ `buttonNode` æœ¬èº«è®¾ç½®ã€‚

---

### 2. è®¾ç½®äº† min/maxWidth/Heightï¼Œå¯èƒ½å¯¼è‡´çº¦æŸå†²çª

ä½ åœ¨ `createImageNodeForAttachment:` é‡ŒåŠ äº†ï¼š

```objc
buttonNode.style.minWidth  = ASDimensionMake(self.imageSize);
buttonNode.style.minHeight = ASDimensionMake(self.imageSize);
buttonNode.style.maxWidth  = ASDimensionMake(self.imageSize);
buttonNode.style.maxHeight = ASDimensionMake(self.imageSize);
```

è¿™ç­‰äºå¼ºè¡ŒæŠŠå®½é«˜é”æ­»ä¸º `imageSize`ï¼Œ**ä½† AsyncDisplayKit å¸ƒå±€æ—¶ stackSpec å·²ç»æä¾›äº†å¤§å°ä¿¡æ¯**ï¼Œè¿™ä¼šè®©ç³»ç»Ÿåœ¨å¸ƒå±€æ—¶ç¼©æ”¾å—é™ï¼Œå¯èƒ½æ˜¾ç¤ºå¼‚å¸¸ã€‚

ğŸ‘‰ ä¿®å¤æ–¹å¼ï¼š
åªä¿ç•™

```objc
buttonNode.style.width  = ASDimensionMake(self.imageSize);
buttonNode.style.height = ASDimensionMake(self.imageSize);
```

å°±è¶³å¤Ÿäº†ã€‚

---

### 3. `scrollNode.layoutSpecBlock` å’Œå¤–å±‚ `layoutSpecThatFits` è®¡ç®—é€»è¾‘é‡å¤ï¼Œå®¹æ˜“å°ºå¯¸ä¸ä¸€è‡´

åœ¨ `setupScrollView` é‡Œä½ å®šä¹‰äº†ï¼š

```objc
self.scrollNode.layoutSpecBlock = ...
```

åŒæ—¶åˆåœ¨ `layoutSpecThatFits:` é‡Œé‡æ–°è®¡ç®— scrollNode å’Œ contentNode çš„å®½åº¦ã€‚
è¿™ä¸¤ä¸ªåœ°æ–¹å¯èƒ½è®¡ç®—å‡ºçš„å®½åº¦ä¸ä¸€è‡´ï¼Œæœ€ç»ˆå¯¼è‡´å›¾ç‰‡åŒºåŸŸè¢«å‹ç¼©ã€‚

ğŸ‘‰ ä¿®å¤æ–¹å¼ï¼š
**åªä¿ç•™ä¸€ä¸ªè®¡ç®—é€»è¾‘**ï¼Œæ¨èä¿ç•™ `layoutSpecThatFits:`ï¼Œç§»é™¤ `scrollNode.layoutSpecBlock`ï¼Œè®© `scrollNode` åªä½œä¸ºå®¹å™¨ã€‚

---

### 4. é¢å¤– `extraMargin = 10.0` å¯èƒ½å¯¼è‡´å†…å®¹å¤§å°åå°/å¯¹é½é”™è¯¯

ä½ åœ¨è®¡ç®—å†…å®¹å®½åº¦æ—¶åŠ äº†ï¼š

```objc
CGFloat extraMargin = 10.0;
totalContentWidth += extraMargin;
```

è¿™ä¸ªâ€œè¡¥ä¸å¼â€çš„ margin ä¼šè®©å¸ƒå±€ä¸ç²¾å‡†ï¼Œå°¤å…¶åœ¨ stackSpec ä¸­æœ¬æ¥ spacing å·²ç»ç®—è¿‡ã€‚
ğŸ‘‰ ä¿®å¤æ–¹å¼ï¼š
å»æ‰ `extraMargin`ï¼Œç›´æ¥ä½¿ç”¨ï¼š

```objc
CGFloat totalContentWidth = self.attachments.count * self.imageSize
                          + (self.attachments.count - 1) * self.imageSpacing;
```

---

âœ… **æ€»ç»“å»ºè®®ä¿®å¤æ–¹æ¡ˆï¼š**

1. ä¸è¦ç”¨ `ASButtonNode` åŒ…è£¹ `ASImageNode/ASNetworkImageNode`ï¼Œé™¤éä½ çœŸçš„éœ€è¦æŒ‰é’®ç‰¹æ€§ï¼›ç‚¹å‡»äº‹ä»¶å¯ä»¥ç›´æ¥åœ¨ `ASImageNode/ASNetworkImageNode` ä¸Šæ·»åŠ  targetã€‚
2. å¦‚æœå¿…é¡»ç”¨ `ASButtonNode`ï¼Œè®°å¾—è®¾ç½® `buttonNode.imageNode.contentMode = UIViewContentModeScaleAspectFill;`ï¼Œå¹¶ç§»é™¤ `min/maxWidth/Height`ã€‚
3. ç§»é™¤ `scrollNode.layoutSpecBlock`ï¼Œåªåœ¨ `layoutSpecThatFits:` é‡Œæ§åˆ¶å°ºå¯¸ã€‚
4. å»æ‰é¢å¤–çš„ `extraMargin`ï¼Œé¿å…è¯¯å·®ã€‚

---

è¦ä¸è¦æˆ‘å¸®ä½ æ”¹ä¸€ä»½ **ç²¾ç®€ç‰ˆä¿®å¤åçš„ `AttachmentScrollNode`**ï¼Œä¿è¯æ—¢èƒ½ç‚¹å‡»åˆèƒ½æ­£ç¡®æ˜¾ç¤ºå¤§å°ï¼Ÿ
