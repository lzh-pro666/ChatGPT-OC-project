# 聊天气泡和输入控件优化说明

## 问题描述

### 1. 文本显示不完全问题
- **现象**：控制台显示完整内容，但屏幕上只显示部分内容
- **示例**：控制台显示完整句子，但屏幕只显示到"聊聊你的日"

### 2. 聊天气泡间距问题
- **现象**：聊天气泡上下内间距太小，视觉效果不够美观
- **需求**：增加聊天气泡的上下内间距

### 3. 输入控件滑动预览问题
- **现象**：输入框超过4行后无法滑动预览
- **需求**：超过4行后支持滑动预览功能

## 解决方案

### 1. 修复文本显示不完全问题

#### 1.1 根本原因分析
文本节点的宽度被限制，导致长文本无法完整显示。主要问题：
- 文本节点的 `maxWidth` 属性限制了宽度扩展
- `flexGrow` 和 `flexShrink` 属性设置不正确
- 布局约束限制了文本节点的宽度

#### 1.2 修复措施
```objc
// 关键修复：移除最大宽度限制，允许文本节点扩展到所需宽度
textNode.style.maxWidth = ASDimensionMake(ASDimensionUnitFraction, 1.0);

// 关键修复：确保文本节点可以显示完整内容
textNode.style.flexGrow = 1.0;
textNode.style.flexShrink = 1.0;
```

#### 1.3 修复范围
- **内容节点**：设置 `flexGrow = 1.0` 和 `flexShrink = 1.0`
- **栈布局**：设置 `flexGrow = 1.0` 和 `flexShrink = 1.0`
- **文本节点**：设置 `flexGrow = 1.0`、`flexShrink = 1.0` 和 `maxWidth = ASDimensionMake(ASDimensionUnitFraction, 1.0)`
- **占位符节点**：设置相同的flex属性

### 2. 优化聊天气泡间距

#### 2.1 内边距优化
```objc
// 外层内边距 - 关键修复：增加上下内边距，让聊天气泡更美观
ASInsetLayoutSpec *contentInset = [ASInsetLayoutSpec insetLayoutSpecWithInsets:UIEdgeInsetsMake(16, 15, 16, 15) child:self.contentNode];
```
- **改进前**：上下内边距为10px
- **改进后**：上下内边距为16px
- **效果**：聊天气泡内容与边框有更好的视觉分隔

#### 2.2 外边距优化
```objc
// 外边距 - 关键修复：增加上下外边距，让聊天气泡之间有更好的视觉分隔
return [ASInsetLayoutSpec insetLayoutSpecWithInsets:UIEdgeInsetsMake(8, 12, 8, 12) child:stackSpec];
```
- **改进前**：上下外边距为5px
- **改进后**：上下外边距为8px
- **效果**：聊天气泡之间有更好的视觉分隔

### 3. 实现输入控件滑动预览功能

#### 3.1 启用滚动功能
```objc
// 关键修复：启用滚动，支持超过4行后的滑动预览
self.inputTextView.scrollEnabled = YES;
```

#### 3.2 智能高度计算
```objc
- (void)textViewDidChange:(UITextView *)textView {
    // 关键修复：动态调整输入框高度，支持超过4行后的滑动预览
    CGSize size = [textView sizeThatFits:CGSizeMake(textView.bounds.size.width, MAXFLOAT)];
    
    // 计算行数
    NSInteger lineCount = [self calculateLineCountForTextView:textView];
    
    if (lineCount <= 4) {
        // 4行以内：自适应高度，最大120px
        CGFloat newHeight = MIN(MAX(size.height, 36), 120);
        
        // 只有当高度变化时才更新约束
        if (self.inputTextViewHeightConstraint.constant != newHeight) {
            self.inputTextViewHeightConstraint.constant = newHeight;
            [self.view layoutIfNeeded];
            [self scrollToBottom]; // 确保滚动到底部
        }
    } else {
        // 超过4行：固定高度为120px，启用滚动
        if (self.inputTextViewHeightConstraint.constant != 120) {
            self.inputTextViewHeightConstraint.constant = 120;
            [self.view layoutIfNeeded];
        }
        
        // 确保滚动到底部，让用户看到最新输入的内容
        [self scrollToBottom];
    }
}
```

#### 3.3 行数计算方法
```objc
// 新增：计算文本视图的行数
- (NSInteger)calculateLineCountForTextView:(UITextView *)textView {
    if (!textView.text || textView.text.length == 0) {
        return 0;
    }
    
    // 使用文本容器的行数计算
    NSLayoutManager *layoutManager = textView.layoutManager;
    NSTextContainer *textContainer = textView.textContainer;
    
    // 获取文本范围
    NSRange textRange = NSMakeRange(0, layoutManager.numberOfGlyphs);
    
    // 计算行数
    NSInteger lineCount = 0;
    NSInteger index = 0;
    
    while (index < textRange.length) {
        NSRange lineRange;
        [layoutManager lineFragmentRectForGlyphAtIndex:index effectiveRange:&lineRange];
        lineCount++;
        index = NSMaxRange(lineRange);
    }
    
    return lineCount;
}
```

## 技术要点

### 1. Flexbox布局原理
- **flexGrow = 1.0**: 允许节点占用所有可用空间
- **flexShrink = 1.0**: 允许节点在必要时缩小，但优先保持内容完整
- **maxWidth = ASDimensionMake(ASDimensionUnitFraction, 1.0)**: 移除宽度限制，允许节点扩展到100%宽度

### 2. 文本节点宽度计算
1. **内容节点**: 设置maxWidth为屏幕宽度的75%
2. **栈布局**: 垂直排列子节点，设置flexGrow = 1.0
3. **文本节点**: 设置flexGrow = 1.0和maxWidth = 100%，允许扩展到父容器宽度
4. **文本渲染**: 根据可用宽度计算换行，确保完整显示

### 3. 输入控件智能高度管理
1. **4行以内**: 自适应高度，最大120px
2. **超过4行**: 固定高度120px，启用滚动
3. **滚动预览**: 用户可以滑动查看所有输入内容

## 预期效果

### 1. 文本完整显示
- 长文本不再被截断
- 自动换行正确工作
- 气泡宽度自适应内容

### 2. 聊天气泡美观
- 内容与边框有合适的间距
- 气泡之间有良好的视觉分隔
- 整体视觉效果更加美观

### 3. 输入控件友好
- 4行以内自适应高度
- 超过4行后支持滑动预览
- 用户体验更加流畅

## 测试要点

### 1. 文本显示测试
- 发送包含长句子的消息
- 验证文本是否完整显示
- 检查自动换行是否正确

### 2. 气泡间距测试
- 查看聊天气泡的视觉效果
- 验证内边距和外边距是否合适
- 检查气泡之间的视觉分隔

### 3. 输入控件测试
- 输入少于4行的文本
- 输入超过4行的文本
- 验证滑动预览功能

## 调试信息

### 1. 布局约束调试
```objc
// 关键调试：输出布局约束信息
NSLog(@"RichMessageCellNode: 布局约束 - maxWidth: %.1f, constrainedSize: %@", 
      maxWidth, NSStringFromCGSize(constrainedSize.max));

// 关键调试：验证文本节点的宽度设置
NSLog(@"RichMessageCellNode: 内容节点flex设置 - flexGrow: %.1f, flexShrink: %.1f", 
      self.contentNode.style.flexGrow, self.contentNode.style.flexShrink);
```

### 2. 文本节点设置调试
```objc
// 关键调试：输出文本节点的宽度设置和内容信息
NSLog(@"RichMessageCellNode: 文本节点设置 - flexGrow: %.1f, flexShrink: %.1f, maxWidth: %@", 
      textNode.style.flexGrow, textNode.style.flexShrink, 
      NSStringFromASDimension(textNode.style.maxWidth));
NSLog(@"RichMessageCellNode: 文本内容长度: %lu, 内容预览: %@", 
      (unsigned long)result.attributedString.string.length,
      [result.attributedString.string substringToIndex:MIN(100, result.attributedString.string.length)]);
```

## 总结

通过这些优化，我们解决了：

1. **文本显示不完全问题**: 通过修复文本节点的flex属性和移除宽度限制
2. **聊天气泡间距问题**: 通过增加内边距和外边距
3. **输入控件滑动预览问题**: 通过智能高度计算和滚动功能

这些改进显著提升了聊天界面的用户体验，使文本显示更完整、气泡更美观、输入控件更友好。

