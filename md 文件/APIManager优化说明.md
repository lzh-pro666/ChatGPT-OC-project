### APIManager 优化说明（2025-09-11）

本文档记录本次对 `APIManager` 的关键改动与性能影响评估，方便后续维护与回溯。

### 变更概览
- UI 增量回调“节流”和不可变快照
  - 新增 per-task 定时器（约每 16ms 触发一次），把多次细碎增量合并后再回调 UI。
  - 在回调前对累积内容 `NSMutableString` 做 `[accumulated copy]`，以 `NSString` 快照传给上层，避免跨线程读写同一可变对象。
- SSE 解析更稳健
  - 兼容事件分隔符 “\n\n” 与 “\r\n\r\n”。
  - 解析时支持多行 `data:`（忽略注释行、空行、前导空格），再拼接后做 JSON 解析；更符合 SSE 语义。
- 回调线程一致性
  - 错误回调、增量回调、完成回调统一 dispatch 到主线程，上层无需关心线程切换。
- BaseURL 与 API Key 线程安全
  - 不再修改全局静态 endpoint；新增 `overriddenBaseURL`，通过实例级配置 + 串行队列保护，避免并发竞态。
  - `setApiKey/currentApiKey` 全部通过 `stateAccessQueue` 访问，提升并发安全性。
- 图片处理优化（尺寸缩放 + 压缩）
  - `base64StringFromImage:` 先将最长边缩放到 ≤ 1536px，再进行 JPEG 压缩（0.7，超大图 0.6），再做 Base64。
- 资源清理完善
  - 在任务完成/错误/取消时停止并移除对应节流定时器与“待更新”标记，避免计时器泄漏与不必要的回调。

### 关键实现细节
- 新增属性
  - `overriddenBaseURL`：线程安全地覆盖默认 BaseURL。
  - `taskThrottleTimers`、`tasksWithPendingUpdate`：用于 per-task UI 节流与待更新标记。
- 节流策略
  - SSE 线程仅将增量 append 到内部 `NSMutableString`，并将任务标记为“有待更新”。
  - 主线程定时器每 ~16ms 读取并复制不可变 `NSString` 快照，再触发 UI 回调；完成时立刻快照 + 停止定时器。
- SSE 解析
  - 使用 CRLF→LF 归一化；收集多行 `data:`，合并为一个 payload，再做 JSON 解析。
  - 遇到 `[DONE]` 时：标记完成、进行最终快照回调，并清理定时器与缓存。

### 性能与稳定性影响（定性评估）
- UI 刷新开销显著降低
  - 由“每个 token/片段一次回调”改为“约 16ms 合并一次”，常见场景主线程回调频率可从每秒 100~300 次降到 ~60 次以内。
  - 布局与富文本 diff 成本下降，滚动/输入体验更平滑；在长回复或高吞吐流式场景尤为明显。
- 线程安全与稳定性提升
  - UI 接收不可变 `NSString` 快照，避免 `NSMutableString` 跨线程访问导致的不确定行为或崩溃。
  - BaseURL、API Key 的并发访问更安全，避免并行请求期间的竞态修改。
- SSE 容错更好，减少解析失败与重试
  - 同时支持 “\n\n/\r\n\r\n” 以及多行 `data:`，降低因行结尾差异导致的丢包或中断概率。
- 图片处理端到端成本降低
  - 先缩放再压缩，能将大图（如 4000×3000）体积降低到原来的 20%~35% 左右；编码耗时与请求体体积同步下降。
- 资源释放及时
  - 任务结束或错误路径主动取消定时器，避免定时器长期存活造成的隐性内存与 CPU 消耗。

### 兼容性与注意事项
- 目前 UI 仍接收“全量快照”而非“纯增量 diff”。如果上层改为按增量拼接，可进一步降低主线程 diff 成本与内存峰值。
- `base64StringFromImage:` 现为同步缩放+压缩：对极大图在主线程调用时可能有短暂阻塞，建议在调用侧放到后台队列处理后再入参，或在 `APIManager` 内部异步化（权衡改动范围）。
- 默认节流间隔为 ~16ms，可根据机型与 UI 复杂度调整（如 12~33ms）。

### 后续可选优化建议
- 在 UI 层改为“append diff”渲染而非重用全量快照，进一步降低富文本重排与测量成本。
- 将图片 Base64 编码与 payload 构建下沉到后台队列，完成后切回主线程触发请求或回调。
- 超长回复分段持久化/分片缓存，控制 `accumulatedContent` 的内存峰值。

### 影响范围
- 主要改动集中在 `ChatGPT-OC-Clone/Model/APIManager.m`，未修改外部接口签名；调用方仅受更稳定的回调线程与节流策略影响，一般无需改动即可获得收益。
