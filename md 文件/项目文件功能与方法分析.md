## 项目文件功能与方法分析

本文件概述 ChatGPT-OC-Clone 工程中每个源文件的职责与其主要方法功能，便于快速理解与维护。内容按目录分组，逐步补充完善。

### Application

- AppDelegate.h/m
  - 主要职责：应用生命周期与 Core Data 栈初始化。
  - 属性：`persistentContainer`：全局 NSPersistentContainer。
  - 方法：
    - `application:didFinishLaunchingWithOptions:` 初始化 `CoreDataManager`。
    - `application:configurationForConnectingSceneSession:options:` 返回默认 `UISceneConfiguration`。
    - `application:didDiscardSceneSessions:` 场景丢弃回调（占位）。
    - `persistentContainer` 懒加载持久化容器，模型名 `chatgpttest2`。
    - `saveContext` 保存上下文并处理错误。

- SceneDelegate.h/m
  - 主要职责：基于 Scene 的窗口与根控制器配置。
  - 属性：`window` 主窗口。
  - 方法：
    - `scene:willConnectToSession:options:` 创建 `UIWindow`，设置 `MainViewController` 为根。
    - 其他场景生命周期方法（占位）。
    - `sceneDidEnterBackground:` 进入后台时调用 `AppDelegate.saveContext`。

- main.m
  - 入口：`UIApplicationMain`，AppDelegate 类名注册。

### Controller

- MainViewController.h/m
  - 职责：AB 测试切换两套聊天详情页（SwiftUI 原版与 Texture V2），并承载导航控制。
  - 属性：`useV2Controller`；内部：`navigationController`、`chatDetailViewController`、`chatDetailViewControllerV2`、`chatsViewController`、`currentChatController`。
  - 方法：
    - `viewDidLoad` 初始化版本选择、视图、CoreData 默认数据、加载首个聊天。
    - `setupViews` 构建并嵌入导航控制器，隐藏导航栏，配置菜单按钮 hook。
    - `setupMenuButton`/`findMenuButtonInChatDetailView`/`findButtonWithSystemImageName:inView:` 动态绑定三横线菜单按钮动作。
    - `showChatsList` 左侧推入聊天列表页面（自定义转场）。
    - `didSelectChat:` Chats 列表回调，设置对应详情页 `chat` 并返回根。
    - `switchToVersion:` 动态切换 V2/原版并保留当前聊天。

- ChatsViewController.h/m
  - 职责：展示会话列表、增删会话。
  - 属性：`tableView`、`chatList`、`addChatButton`；委托 `ChatsViewControllerDelegate`。
  - 方法：
    - 视图：`viewDidLoad`/`viewWillAppear:` `setupViews` 搭建头部与表格，注册 cell，配置手势。
    - 数据：`fetchChats` 从 `CoreDataManager` 读取；`createNewChat` 新建并通知 delegate。
    - UITableView 数据源与代理：`numberOfRowsInSection`、`cellForRowAtIndexPath`、`didSelectRowAtIndexPath`、`heightForRowAtIndexPath`。
    - 手势与菜单：`handleLongPress:` 弹出删除 ActionSheet；`handleSwipe:` 左滑返回；`deleteChat:` 删除并在空列表时自动新建。

- ChatDetailViewController.h/m（原版，SwiftUI 容器）
  - 职责：使用 SwiftUI 作为聊天区渲染；UIKit 管理输入区、附件、AI 流式响应与打字机动画。
  - 关键属性：`chatViewModel`、`chatSwiftUIWrapper`、输入相关视图与约束、`selectedAttachments`、`isAIThinking`、流式缓冲与定时器、网络任务等。
  - 关键方法：
    - 生命周期：`viewDidLoad` 组装 UI、加载消息、注册通知、读取用户设置。
    - UI：`setupViews`、`setupHeader`、`setupInputArea`、滚动辅助 `scrollToBottom*`。
    - 数据：`fetchMessages` 初次无消息注入欢迎语；`syncMessagesToSwiftUI` 同步到 ViewModel。
    - 输入与附件：`textViewDidChange` 动态高度与粘底；`updateAttachmentsDisplay` 生成/收起缩略图；`mediaPicker` 回调；`generateThumbnailForURL`。
    - 发送与流式：`sendButtonTapped` 保存用户消息并触发 `simulateAIResponse`；
      - `simulateAIResponse` 通过 `APIManager` 建立流，首包时插入 AI 消息并启动打字机；
      - 定时器 `typeNextChunk:` 按块推进，`debouncedUpdateMessage:` 合并更新，完成时 `stopTypingTimer` 持久化最终文本。
    - 弹窗：API Key 设置与模型选择。

- ChatDetailViewControllerV2.h/m（V2，Texture 渲染）
  - 职责：基于 Texture 的高性能富文本逐行渲染，支持多媒体缩略图、阿里云 OSS 上传、多模态理解/生成分流、智能粘底滚动。
  - 关键属性：`ASTableNode`、输入区与附件栈、缓存与粘底状态、`fullResponseBuffer`、`currentUpdatingAIMessage`、`_currentUpdatingAINode` 等。
  - 关键方法：
    - 视图搭建：`setupViews`/`setupHeader`/`setupInputArea` 配置表、输入区、工具栏与约束。
    - 数据：`fetchMessages`；`addMessageWithText:attachments:isFromUser:completion:` 插入行并滚动。
    - 附件：`updateAttachmentsDisplay`/`deleteAttachmentAtIndex:`/`generateThumbnailForURL:`。
    - 发送：`sendButtonTapped` 若有附件则经 `OSSUploadManager` 上传并规范化为“附件链接块”。
    - 多模态：`simulateAIResponse` 内部在有图片时先 `classifyIntent` 判断“生成/理解”，分别调用 `generateImageWithPrompt` 或切换多模态端点流式；`latestUserPlainText` 提取用于多模态文本。
    - 流式渲染：`nodeBlockForRowAtIndexPath` 选择 `RichMessageCellNode`/`MessageCellNode`/`MediaMessageCellNode`；
      增量回调中维护 `lastDisplayedSubstring` 避免重复；`completeStreamingUpdate` 完成富文本渲染；
      一系列滚动与粘底辅助：`ensureBottomVisible:`、`performUpdatesPreservingBottom:`、`autoStickAfterUpdate` 等。
    - 键盘与通知：`keyboardWillShow/Hide`、应用前后台处理；缩略图预览通知。

### 后续待补充目录（将在下一版补齐）

- Model/
  - APIManager.h/m
    - 职责：统一封装与兼容 OpenAI/DashScope 等端点的流式对话、多模态与图片生成；提供意图分类。
    - 关键属性：`apiKey`、`currentModelName`、`defaultSystemPrompt`、会话与任务状态字典。
    - 关键方法：
      - `setBaseURL:/currentBaseURL` 切换 API 端点。
      - `streamingChatCompletionWithMessages:...` 两个重载（文本/图文），SSE 解析回调部分内容与完成标记。
      - `cancelStreamingTask:` 取消任务（清理在完成回调内处理）。
      - `classifyIntentWithMessages:temperature:completion:` 判断“生成/理解”。
      - `generateImageWithPrompt:baseImageURL:completion:` 走 DashScope 生成图片，解析返回 URL 列表。
  - CoreDataManager.h/m
    - 职责：Core Data 栈封装（`chatgpttest2` 模型）；Chat/Message 的 CRUD。
    - 方法：`persistentContainer`/`managedObjectContext`/`saveContext`；`createNewChatWithTitle:`、`addMessageToChat:content:isFromUser:`、`fetchAllChats`、`fetchMessagesForChat:`、`setupDefaultChatsIfNeeded`。
  - AIMarkdownParser.h/m
    - 职责：轻量 Markdown 解析，段落/标题/围栏代码/列表/引用；可用于富文本渲染前处理。
    - 方法：`parse:` 返回 `AIMarkdownBlock` 数组；内部围栏与标题正则，代码块进入/结束日志。
  - AISyntaxHighlighter.h/m
    - 职责：代码语法高亮，按语言规则返回带属性的 `NSAttributedString`，含缓存。
    - 方法：`highlightCode:language:fontSize:`、`rulesForLanguage:`；`AICodeTheme.defaultTheme` 提供配色。
  - ParserResult.h/m
    - 职责：解析结果承载体，包含富文本、是否代码块、语言等。
  - ResponseParsingTask.h/m
    - 职责：异步/分批解析文本，阈值控制重解析，生成标题/分隔/列表/粗斜体/行内代码样式。
    - 方法：`parseText:`、`parseTextWithThreshold:`、`shouldReparseText:lastParsedText:threshold:`。

- View/
  - 组件与 Node：`RichMessageCellNode`、`MessageCellNode`、`MediaMessageCellNode`、`ThinkingNode`、`AttachmentThumbnailView`、`AICodeBlockNode` 等，用于 Texture 或 UIKit 展示气泡、媒体缩略图与代码块。
  - 关键点：
    - 富文本节点配合 `ResponseParsingTask` 实现逐行增量渲染；
    - 多媒体节点支持附件数组；
    - 代码块节点配合 `AISyntaxHighlighter` 与 `AIMarkdownParser`。
  - 已读文件：
    - AttachmentThumbnailView.h/m：缩略图容器，内置删除按钮，回调 `deleteAction`。
    - CustomMenuView.h/m：底部工具菜单（照片/摄像头/文件），弹出/收起动画，代理回调所选项。
    - ImagePreviewOverlay.h/m：图片预览遮罩，支持本地图或网络 URL（PINRemoteImage），带复制/分享/关闭。
    - ChatCell.h/m：会话列表单元格，标题/日期显示与“今天/昨天/周几/日期”格式化。

- Tool/
  - AlertHelper.h/m：统一弹窗工具（API Key、模型选择、权限、确认、成功/错误提示）。
  - MediaPickerManager.h/m：相册/相机/文件选择，代理回调图片数组或文件 URL；含权限处理与多选。
  - OSSUploadManager.h/m：阿里云 OSS 上传单例，支持图片或本地文件 URL 批量上传，返回公网 URL 列表。

- Services/
  - 业务服务分层目录（Attachment/Chat/Scroll/Streaming/Upload），当前实现主要集中在 Controller/Tool 中，后续可迁移服务逻辑以解耦。
- Rendering/
  - 渲染相关分层（Highlight/Layout/Mapping/Markdown），与富文本/代码高亮/布局策略相关，具体实现见 View 与 Model 解析/高亮模块配合。

- reference/
  - Swift 参考实现与共享组件：`Shared/` 内含 `ChatGPTAPI.swift`、`ViewModel.swift`、`MarkdownAttributedStringParser.swift` 等，可对照 Objective‑C 版本逻辑。
  - 已读文件：
    - ChatGPTAPI.swift：封装 OpenAI Chat Completions（流式与非流式），管理历史与请求体，SSE 行解析。
    - ViewModel.swift：SwiftUI 聊天状态与流式渲染，集成 `ResponseParsingTask` 进行 64 字符阈值增量解析与富文本拼接；含语音播报选项。

（文档编写中，稍后补齐所有文件的方法级说明。）


